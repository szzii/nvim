{
  "metadata": {
    "version": "1.1",
    "created_at": "2025-12-30",
    "updated_at": "2025-12-30",
    "config_path": "/Users/szz/.config/nvim",
    "total_optimizations": 16,
    "completed_optimizations": 11,
    "pending_optimizations": 5,
    "priority_breakdown": {
      "A": 9,
      "B": 5,
      "C": 2
    }
  },
  "optimizations": [
    {
      "id": 1,
      "priority": "A",
      "category": "performance",
      "title": "LSP Document Highlight Augroup 统一管理",
      "file": "lua/plugins/lsp.lua",
      "line_range": "37-67",
      "status": "completed",
      "completed_at": "2025-12-30",
      "problem": "每个 LSP attach 都创建独立的 document highlight autocmd，没有使用 augroup 管理，可能导致内存泄漏和重复执行",
      "current_code": "vim.api.nvim_create_autocmd({\"CursorHold\", \"CursorHoldI\"}, {\n    buffer = ev.buf,\n    callback = vim.lsp.buf.document_highlight,\n})",
      "solution": "使用统一的 augroup 管理所有 document highlight autocmd，避免重复创建和内存泄漏",
      "code_diff": [
        "在 LspAttach autocmd 外部创建 augroup:",
        "local doc_highlight_augroup = vim.api.nvim_create_augroup(\"LSPDocumentHighlight\", { clear = true })",
        "",
        "然后在 autocmd 中使用 group:",
        "vim.api.nvim_create_autocmd({\"CursorHold\", \"CursorHoldI\"}, {",
        "    group = doc_highlight_augroup,  -- 添加这行",
        "    buffer = ev.buf,",
        "    callback = vim.lsp.buf.document_highlight,",
        "})",
        "",
        "同时需要修改 CursorMoved 的 clear_references autocmd"
      ],
      "expected_benefit": "减少内存占用，避免 autocmd 泄漏，每次 LSP attach 时不会创建重复的 autocmd",
      "impact": "high",
      "risk": "low",
      "estimated_effort": "5 minutes"
    },
    {
      "id": 2,
      "priority": "A",
      "category": "performance",
      "title": "Signature Help 防抖优化",
      "file": "lua/plugins/lsp.lua",
      "line_range": "100-135",
      "status": "completed",
      "completed_at": "2025-12-30",
      "problem": "每次 TextChangedI 事件都检查当前字符，频繁触发 LSP signature help 请求，造成性能开销",
      "current_code": "vim.api.nvim_create_autocmd(\"TextChangedI\", {\n    buffer = ev.buf,\n    callback = function()\n        local line = vim.api.nvim_get_current_line()\n        local col = vim.api.nvim_win_get_cursor(0)[2]\n        local char = line:sub(col, col)\n        if char == \"(\" or char == \",\" then\n            vim.lsp.buf.signature_help()\n        end\n    end\n})",
      "solution": "添加防抖机制，避免短时间内多次触发",
      "code_diff": [
        "使用 vim.defer_fn 实现防抖:",
        "local signature_timer = nil",
        "vim.api.nvim_create_autocmd(\"TextChangedI\", {",
        "    buffer = ev.buf,",
        "    callback = function()",
        "        if signature_timer then",
        "            vim.fn.timer_stop(signature_timer)",
        "        end",
        "        signature_timer = vim.fn.timer_start(200, function()",
        "            local line = vim.api.nvim_get_current_line()",
        "            local col = vim.api.nvim_win_get_cursor(0)[2]",
        "            local char = line:sub(col, col)",
        "            if char == \"(\" or char == \",\" then",
        "                vim.lsp.buf.signature_help()",
        "            end",
        "        end)",
        "    end",
        "})",
        "",
        "或者使用 Lua 的 debounce 库"
      ],
      "expected_benefit": "减少 70%+ 的不必要 LSP signature help 请求",
      "impact": "high",
      "risk": "low",
      "estimated_effort": "10 minutes"
    },
    {
      "id": 3,
      "priority": "A",
      "category": "performance",
      "title": "Lualine 刷新间隔优化",
      "file": "lua/plugins/ui.lua",
      "line_range": "23-27",
      "status": "completed",
      "completed_at": "2025-12-30",
      "problem": "refresh 设置为 1000ms 导致状态栏更新延迟明显，用户感觉不流畅",
      "current_code": "refresh = {\n    statusline = 1000,\n    tabline = 1000,\n    winbar = 1000,\n}",
      "solution": "降低刷新间隔到 50-100ms",
      "code_diff": [
        "refresh = {",
        "    statusline = 100,  -- 从 1000 改为 100",
        "    tabline = 100,",
        "    winbar = 100,",
        "}"
      ],
      "expected_benefit": "状态栏响应更流畅，减少用户感知的延迟",
      "impact": "medium",
      "risk": "low",
      "estimated_effort": "2 minutes"
    },
    {
      "id": 4,
      "priority": "B",
      "category": "performance",
      "title": "Todo-comments 搜索性能限制",
      "file": "lua/plugins/base.lua",
      "line_range": "51-60",
      "status": "completed",
      "completed_at": "2025-12-30",
      "problem": "rg 搜索未设置深度限制，大型项目中可能搜索很深，导致性能问题",
      "current_code": "search = {\n    command = \"rg\",\n    args = {\n        \"--color=never\",\n        \"--no-heading\",\n        \"--with-filename\",\n        \"--line-number\",\n        \"--column\",\n    },",
      "solution": "添加 --max-depth 限制搜索深度",
      "code_diff": [
        "args = {",
        "    \"--color=never\",",
        "    \"--no-heading\",",
        "    \"--with-filename\",",
        "    \"--line-number\",",
        "    \"--column\",",
        "    \"--max-depth=5\",  -- 添加这行",
        "},"
      ],
      "expected_benefit": "大型项目中搜索速度提升",
      "impact": "medium",
      "risk": "low",
      "estimated_effort": "2 minutes"
    },
    {
      "id": 5,
      "priority": "B",
      "category": "performance",
      "title": "Treesitter 大文件性能保护",
      "file": "lua/plugins/ui.lua",
      "line_range": "167-178",
      "status": "completed",
      "completed_at": "2025-12-30",
      "problem": "大文件使用 Treesitter 高亮可能导致性能问题，未设置文件大小限制",
      "current_code": "highlight = {\n    enable = true,\n    additional_vim_regex_highlighting = false,\n}",
      "solution": "添加基于文件大小的动态禁用",
      "code_diff": [
        "highlight = {",
        "    enable = true,",
        "    disable = function(lang, buf)",
        "        local max_filesize = 100 * 1024 -- 100KB",
        "        local ok, stats = pcall(vim.loop.fs_stat, vim.api.nvim_buf_get_name(buf))",
        "        if ok and stats and stats.size > max_filesize then",
        "            return true",
        "        end",
        "    end,",
        "    additional_vim_regex_highlighting = false,",
        "}"
      ],
      "expected_benefit": "大文件打开速度显著提升",
      "impact": "medium",
      "risk": "low",
      "estimated_effort": "5 minutes"
    },
    {
      "id": 6,
      "priority": "B",
      "category": "performance",
      "title": "Bufferline 性能保护",
      "file": "lua/plugins/ui.lua",
      "line_range": "51-61",
      "status": "completed",
      "completed_at": "2025-12-30",
      "problem": "大量 buffer 时可能导致渲染卡顿，未设置截断和性能保护",
      "current_code": "options = {\n    style_preset = bufferline.style_preset.no_italic,",
      "solution": "添加名称长度限制和其他性能优化",
      "code_diff": [
        "options = {",
        "    style_preset = bufferline.style_preset.no_italic,",
        "    max_name_length = 18,      -- 限制 buffer 名称长度",
        "    tab_size = 18,",
        "    truncate_names = true,     -- 启用名称截断",
        "    -- numbers 配置保持不变",
        "},"
      ],
      "expected_benefit": "大量 buffer 时性能提升",
      "impact": "low",
      "risk": "low",
      "estimated_effort": "3 minutes"
    },
    {
      "id": 7,
      "priority": "C",
      "category": "performance",
      "title": "updatetime 参数调整",
      "file": "lua/options.lua",
      "line_range": "57",
      "status": "completed",
      "completed_at": "2025-12-30",
      "problem": "updatetime 设置为 300ms，对于 CursorHold 等事件触发较慢",
      "current_code": "vim.opt.updatetime = 300",
      "solution": "降低到 100-200ms",
      "code_diff": [
        "vim.opt.updatetime = 100  -- 从 300 改为 100"
      ],
      "expected_benefit": "CursorHold 触发更快，但会略微增加 CPU 使用",
      "impact": "low",
      "risk": "low",
      "estimated_effort": "1 minute"
    },
    {
      "id": 8,
      "priority": "A",
      "category": "plugin",
      "title": "AI 助手插件重复",
      "file": "lua/plugins/ai.lua",
      "line_range": "1-27",
      "status": "pending",
      "problem": "同时启用 Copilot 和可能的其他 AI 助手（如 Avante），资源占用且功能重复",
      "current_code": "-- ai.lua 中配置了 copilot.vim\n-- 可能还有其他 AI 助手配置",
      "solution": "通过 local.lua 的 copilot_enabled 标志控制，或选择一个主要的 AI 助手",
      "code_diff": [
        "已经在 ai.lua 中实现了 copilot_enabled 控制:",
        "local copilot_enabled = ok and local_config.copilot_enabled or true",
        "",
        "建议在 local.lua 中明确设置:",
        "return {",
        "    copilot_enabled = false,  -- 禁用 Copilot，使用其他 AI 助手",
        "    -- 或",
        "    copilot_enabled = true,   -- 只使用 Copilot",
        "}"
      ],
      "expected_benefit": "减少内存占用，避免 AI 插件冲突",
      "impact": "high",
      "risk": "medium",
      "estimated_effort": "5 minutes"
    },
    {
      "id": 9,
      "priority": "A",
      "category": "plugin",
      "title": "Alpha-nvim 条件加载",
      "file": "lua/plugins/base.lua",
      "line_range": "67-79",
      "status": "completed",
      "completed_at": "2025-12-30",
      "problem": "event = \"VimEnter\" 每次启动都触发，打开文件时会不必要地加载启动页",
      "current_code": "{\n    \"goolord/alpha-nvim\",\n    event = \"VimEnter\",\n    dependencies = { 'nvim-tree/nvim-web-devicons' },",
      "solution": "只在空目录启动时加载",
      "code_diff": [
        "{",
        "    \"goolord/alpha-nvim\",\n    event = function()\n        -- 只在没有打开文件时加载\n        if vim.fn.argc() == 0 then\n            return \"VimEnter\"\n        end\n    end,",
        "    dependencies = { 'nvim-tree/nvim-web-devicons' },",
        "    -- 其余配置不变",
        "}"
      ],
      "expected_benefit": "打开文件时避免加载启动页，提升启动速度",
      "impact": "medium",
      "risk": "low",
      "estimated_effort": "3 minutes"
    },
    {
      "id": 10,
      "priority": "A",
      "category": "plugin",
      "title": "基础插件延迟加载",
      "file": "lua/plugins/base.lua",
      "line_range": "3-42",
      "status": "completed",
      "completed_at": "2025-12-30",
      "problem": "nvim-lastplace 和 nvim-scrollbar 未设置延迟加载",
      "current_code": "{\n    \"ethanholz/nvim-lastplace\",\n    config = function()...",
      "solution": "添加适当的 event 触发条件",
      "code_diff": [
        "nvim-lastplace:",
        "{",
        "    \"ethanholz/nvim-lastplace\",\n    event = \"BufReadPre\",  -- 添加这行",
        "    config = function()...",
        "",
        "nvim-scrollbar:",
        "{",
        "    \"petertriho/nvim-scrollbar\",\n    event = \"BufReadPost\",  -- 添加这行",
        "    dependencies = { 'kevinhwang91/nvim-hlslens' },",
        "    config = function()..."
      ],
      "expected_benefit": "减少启动时的插件加载",
      "impact": "medium",
      "risk": "low",
      "estimated_effort": "3 minutes"
    },
    {
      "id": 11,
      "priority": "B",
      "category": "plugin",
      "title": "Symbols-outline 优化",
      "file": "lua/plugins/cmp.lua",
      "line_range": "186-235",
      "status": "pending",
      "problem": "symbols-outline 会发送额外的 LSP 请求，可能影响性能",
      "current_code": "已经设置了 lazy = true，只在按键时加载",
      "solution": "考虑使用轻量级替代方案，或保持现状（已经做了 lazy 加载）",
      "code_diff": [
        "当前配置已经很好：",
        "lazy = true,",
        "keys = {",
        "    { \"<leader>p\", \":SymbolsOutline<CR>\", ... }",
        "}",
        "",
        "如果需要进一步优化，可以考虑：",
        "- 使用 Telescope 的 symbols picker",
        "- 使用 nvim-treehopper",
        "- 或保持现状"
      ],
      "expected_benefit": "可选：减少 LSP 请求数量",
      "impact": "low",
      "risk": "medium",
      "estimated_effort": "15 minutes (如果替换)"
    },
    {
      "id": 12,
      "priority": "B",
      "category": "plugin",
      "title": "Markdown-preview 条件构建",
      "file": "lua/plugins/edit.lua",
      "line_range": "59-68",
      "status": "completed",
      "completed_at": "2025-12-30",
      "problem": "build 命令假设系统有 yarn，如果没有会导致插件安装失败",
      "current_code": "build = \"cd app && yarn install\",",
      "solution": "添加条件构建，只在 yarn 存在时执行",
      "code_diff": [
        "build = function()\n    if vim.fn.executable(\"yarn\") == 1 then\n        return \"cd app && yarn install\"\n    end\n    -- 如果没有 yarn，跳过构建（假设已经构建过）",
        "end,",
        "",
        "或者使用 pcall:",
        "build = \"cd app && (yarn install || echo 'Yarn not found, skipping build')\""
      ],
      "expected_benefit": "避免在没有 yarn 的系统上插件安装失败",
      "impact": "low",
      "risk": "low",
      "estimated_effort": "3 minutes"
    },
    {
      "id": 13,
      "priority": "B",
      "category": "plugin",
      "title": "使用 Mason 管理 LSP",
      "file": "lua/lsp/jdtls.lua",
      "line_range": "1-193",
      "status": "pending",
      "problem": "手动配置 JDTLS 路径，维护成本高，不便于更新",
      "current_code": "local jdtls_path = vim.fn.stdpath('data') .. \"/custom_lsp/jdtls\"",
      "solution": "考虑使用 mason.nvim + jdtls 安装和管理",
      "code_diff": [
        "需要添加 Mason 配置到 plugins/lsp.lua:",
        "{",
        "    \"williamboman/mason.nvim\",",
        "    \"williamboman/mason-lspconfig.nvim\",",
        "    config = function()",
        "        require(\"mason\").setup()",
        "        require(\"mason-lspconfig\").setup({",
        "            ensure_installed = { \"jdtls\", ... },",
        "        })",
        "    end,",
        "}",
        "",
        "注意：JDTLS 的配置会比较复杂，需要谨慎迁移"
      ],
      "expected_benefit": "便于 LSP 管理和更新",
      "impact": "medium",
      "risk": "high",
      "estimated_effort": "30 minutes"
    },
    {
      "id": 14,
      "priority": "C",
      "category": "plugin",
      "title": "插件现代化替换",
      "file": "lua/plugins/edit.lua",
      "line_range": "1-66",
      "status": "pending",
      "problem": "一些老插件可以被现代 Lua 实现替代，可能有性能提升",
      "current_code": "\"tpope/vim-surround\",",
      "solution": "考虑替换为现代实现",
      "code_diff": [
        "可选替换方案:",
        "",
        "1. vim-surround -> mini.surround (更轻量)",
        "{",
        "    \"echasnovski/mini.surround\",",
        "    version = \"*\",",
        "    config = function()",
        "        require(\"mini.surround\").setup()",
        "    end,",
        "}",
        "",
        "2. wildfire.vim -> nvim-treesitter-textobjects",
        "",
        "3. vim-visual-multi -> 保持（功能强大，无直接替代）"
      ],
      "expected_benefit": "可能有小幅性能提升",
      "impact": "low",
      "risk": "medium",
      "estimated_effort": "20 minutes"
    },
    {
      "id": 15,
      "priority": "C",
      "category": "configuration",
      "title": "配置模块化",
      "file": "lua/lsp/jdtls.lua",
      "line_range": "18-61",
      "status": "pending",
      "problem": "JVM 参数硬编码在配置中，不够灵活",
      "current_code": "cmd = {\n    '/Library/Java/JavaVirtualMachines/...',",
      "solution": "提取 JVM 参数到单独的配置文件",
      "code_diff": [
        "创建 lua/config/jvm.lua:",
        "return {",
        "    jvm_args = {",
        "        \"-Xmx1G\",",
        "        \"-Xms512m\",",
        "        -- ... 其他参数",
        "    }",
        "}",
        "",
        "然后在 jdtls.lua 中:",
        "local jvm_config = require(\"config.jvm\")",
        "cmd = vim.list_extend({java_path}, jvm_config.jvm_args, {jar_args})"
      ],
      "expected_benefit": "配置更清晰，便于维护",
      "impact": "low",
      "risk": "low",
      "estimated_effort": "10 minutes"
    },
    {
      "id": 16,
      "priority": "C",
      "category": "performance",
      "title": "添加性能监控",
      "file": "init.lua",
      "line_range": "18-39",
      "status": "completed",
      "completed_at": "2025-12-30",
      "problem": "缺少性能监控，难以量化优化效果",
      "current_code": "未配置 lazy.nvim 的 performance 选项",
      "solution": "启用 lazy.nvim 的性能追踪和禁用未使用的内置插件",
      "code_diff": [
        "在 require(\"lazy\").setup() 中添加:",
        "require(\"lazy\").setup(\"plugins\", {",
        "    performance = {",
        "        rtp = {",
        "            disabled_plugins = {",
        "                \"gzip\",",
        "                \"tarPlugin\",",
        "                \"tohtml\",",
        "                \"tutor\",",
        "                \"zipPlugin\",",
        "                \"netrwPlugin\",  -- 如果使用 neo-tree",
        "            },",
        "        },",
        "    },",
        "})",
        "",
        "启用性能分析:",
        "-- 在启动时添加 --profile 参数",
        "vim.keymap.set(\"n\", \"<leader>pp\", function()",
        "    require(\"lazy\").profile()",
        "end)"
      ],
      "expected_benefit": "可以量化优化效果，发现性能瓶颈",
      "impact": "medium",
      "risk": "low",
      "estimated_effort": "5 minutes"
    }
  ],
  "priority_order": [
    1, 2, 3, 8, 9, 10,
    4, 5, 6, 11, 12, 13,
    7, 14, 15, 16
  ]
}
